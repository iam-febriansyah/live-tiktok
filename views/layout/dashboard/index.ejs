<%- include('../../partials/header.ejs') %>

<!--Swiper slider css-->
<link href="assets/libs/swiper/swiper-bundle.min.css" rel="stylesheet" type="text/css" />
<style>
</style>

<%- include('../../partials/topbar.ejs') %>
<%- include('../../partials/sidebar.ejs') %>


<div class="main-content">
  <div class="page-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <div class="page-title-box d-sm-flex align-items-center justify-content-between">
            <h4 class="mb-sm-0">Analytics</h4>
            <div class="page-title-right">
              <ol class="breadcrumb m-0">
                <li class="breadcrumb-item"><a href="javascript: void(0);">Dashboards</a></li>
                <li class="breadcrumb-item active">Analytics</li>
              </ol>
            </div>
          </div> 
        </div>
        <div class="col-12">
          <div class="row">
            <div class="col-xl-12 col-md-12">
              
            </div>
          </div>
        </div>
        <div class="col-sm-6" style="display: n1one;">
          <div class="row">
            <div class="col-xl-4 col-md-4">
                <div class="card card-animate overflow-hidden">
                    <div class="position-absolute start-0" style="z-index: 0;">
                        <svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120" width="200" height="120">
                            <style>
                                .s0 {
                                    opacity: .05;
                                    fill: var(--vz-success)
                                }
                            </style>
                            <path id="Shape 8" class="s0" d="m189.5-25.8c0 0 20.1 46.2-26.7 71.4 0 0-60 15.4-62.3 65.3-2.2 49.8-50.6 59.3-57.8 61.5-7.2 2.3-60.8 0-60.8 0l-11.9-199.4z" />
                        </svg>
                    </div>
                    <div class="card-body" style="z-index:1 ;">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1 overflow-hidden">
                                <p class="text-uppercase fw-medium text-muted text-truncate mb-3">Semua<br>Jenis Material</p>
                                <h4 class="fs-22 fw-semibold ff-secondary mb-0"><span class="counter-value" id="jenis_material" data-target="0">0</span></h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-md-4">
              <div class="card card-animate overflow-hidden">
                  <div class="position-absolute start-0" style="z-index: 0;">
                      <svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120" width="200" height="120">
                          <style>
                              .s0 {
                                  opacity: .05;
                                  fill: var(--vz-success)
                              }
                          </style>
                          <path id="Shape 8" class="s0" d="m189.5-25.8c0 0 20.1 46.2-26.7 71.4 0 0-60 15.4-62.3 65.3-2.2 49.8-50.6 59.3-57.8 61.5-7.2 2.3-60.8 0-60.8 0l-11.9-199.4z" />
                      </svg>
                  </div>
                  <div class="card-body" style="z-index:1 ;">
                      <div class="d-flex align-items-center">
                          <div class="flex-grow-1 overflow-hidden">
                              <p class="text-uppercase fw-medium text-muted text-truncate mb-3"> Material Ckr<br>Kurang dr Rata-rata</p>
                              <h4 class="fs-22 fw-semibold ff-secondary mb-0"><span class="counter-value" id="avg_6410" data-target="0">0</span></h4>
                          </div>
                      </div>
                  </div>
              </div>
            </div>
            <div class="col-xl-4 col-md-4">
              <div class="card card-animate overflow-hidden">
                  <div class="position-absolute start-0" style="z-index: 0;">
                      <svg version="1.2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 120" width="200" height="120">
                          <style>
                              .s0 {
                                  opacity: .05;
                                  fill: var(--vz-success)
                              }
                          </style>
                          <path id="Shape 8" class="s0" d="m189.5-25.8c0 0 20.1 46.2-26.7 71.4 0 0-60 15.4-62.3 65.3-2.2 49.8-50.6 59.3-57.8 61.5-7.2 2.3-60.8 0-60.8 0l-11.9-199.4z" />
                      </svg>
                  </div>
                  <div class="card-body" style="z-index:1 ;">
                      <div class="d-flex align-items-center">
                          <div class="flex-grow-1 overflow-hidden">
                              <p class="text-uppercase fw-medium text-muted text-truncate mb-3"> Material Krw<br>Kurang dr Rata-rata</p>
                              <h4 class="fs-22 fw-semibold ff-secondary mb-0"><span class="counter-value" id="avg_6420" data-target="0">0</span></h4>
                          </div>
                      </div>
                  </div>
              </div>
            </div>
            <div class="col-xl-12 col-md-12">
              <div class="card">
                <ul class="nav nav-pills arrow-navtabs nav-success bg-light mb-3" role="tablist">
                  <li class="nav-item">
                      <a class="nav-link active" data-bs-toggle="tab" href="#avg-ckr" role="tab">
                          <span class="d-block d-sm-none"><i class="mdi mdi-home-variant"></i></span>
                          <span class="d-none d-sm-block">Cikarang</span>
                      </a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#avg-krw" role="tab">
                          <span class="d-block d-sm-none"><i class="mdi mdi-home-variant"></i></span>
                          <span class="d-none d-sm-block">Karawang</span>
                      </a>
                  </li>
                </ul>
                <div class="tab-content text-muted">
                  <div class="tab-pane active table-responsive" id="avg-ckr" role="tabpanel">
                    <table class="table table-responsive table-list" style="width: 100%;" id="tblAvg1">
                      <thead>
                        <tr>
                          <th colspan="4">10 MATERIAL YANG KURANG DARI JUMLAH RATA-RATA </th>
                          <th class="text-right"><a href="/inventory-avgstock-yearmonth">LIHAT SEMUA</a></th>
                        </tr>
                      </thead>
                      <thead>
                        <tr>
                          <th style="width: 20;">Material Number</th>
                          <th style="width: 32;">Material Desc</th>
                          <th style="width: 15;" class="text-center">Stok</th>
                          <th style="width: 15;" class="text-center">Avg</th>
                          <th style="width: 18;" class="text-center">Kurang</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyAvg1" ></tbody>
                    </table>
                  </div>
                  <div class="tab-pane table-responsive" id="avg-krw" role="tabpanel">
                    <table class="table table-responsive table-list" style="width: 100%;" id="tblAvg2">
                      <thead>
                        <tr>
                          <th colspan="4">10 MATERIAL YANG KURANG DARI JUMLAH RATA-RATA </th>
                          <th class="text-right"><a href="/inventory-avgstock-yearmonth">LIHAT SEMUA</a></th>
                        </tr>
                      </thead>
                      <thead>
                        <tr>
                          <th style="width: 20;">Material Number</th>
                          <th style="width: 32;">Material Desc</th>
                          <th style="width: 15;" class="text-center">Stok</th>
                          <th style="width: 15;" class="text-center">Avg</th>
                          <th style="width: 18;" class="text-center">Kurang</th>
                        </tr>
                      </thead>
                      <tbody id="tbodyAvg2" ></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6" style="display: n1one;">
          <div class="row" style="display: none;" id="divUpdatingStock">
              <div class="alert alert-danger alert-border-left alert-dismissible fade show" role="alert">
                Sedang running updating stock ... <b id="updatingStok">0/0</b>
              </div>
          </div>
          <div class="row">
            <div class="card">
                <div class="card-header border-0 align-items-center d-flex">
                  <h4 class="card-title mb-0 flex-grow-1">Pemakaian 10 Material Terbanyak <u id="title10Material">CIKARANG</u></h4>
                  <div>
                      <button type="button" onclick="getCharts10MaterialOut(1)" class="btn btn-soft-secondary btn-sm">
                          CIKARANG
                      </button>
                      <button type="button" onclick="getCharts10MaterialOut(2)" class="btn btn-soft-secondary btn-sm">
                          KARAWANG
                      </button>
                  </div>
                </div>

                <!-- <div class="card-header p-0 border-0 bg-soft-light">
                    <div class="row g-0 text-center">
                        <div class="col-6 col-sm-4">
                            <div class="p-3 border border-dashed border-start-0">
                                <h5 class="mb-1"><span class="counter-value" data-target="7585">0</span></h5>
                                <p class="text-muted mb-0">Karawang</p>
                            </div>
                        </div>
                        <div class="col-6 col-sm-4">
                            <div class="p-3 border border-dashed border-start-0">
                                <h5 class="mb-1"><span class="counter-value" data-target="22.89">0</span>k</h5>
                                <p class="text-muted mb-0">Cikarang</p>
                            </div>
                        </div>
                        <div class="col-6 col-sm-4">
                            <div class="p-3 border border-dashed border-start-0">
                                <h5 class="mb-1"><span class="counter-value" data-target="367">0</span></h5>
                                <p class="text-muted mb-0">Semua Plant</p>
                            </div>
                        </div>
                    </div>
                </div> -->

                <div class="card-body p-0 pb-2">
                    <div class="w-100">
                        <div id="customer_impression_charts" data-colors='["--vz-primary", "--vz-success", "--vz-danger"]' class="apex-charts" dir="ltr"></div>
                    </div>
                </div><!-- end card body -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <%- include('../../partials/footer.ejs') %>
</div>
<div id="modalLoading"></div>


<%- include('../../partials/customizer.ejs') %>
<%- include('../../partials/vendor-scripts.ejs') %>


<script src="/velzon/assets/libs/jsvectormap/js/jsvectormap.min.js"></script>
<script src="/velzon/assets/libs/jsvectormap/maps/world-merc.js"></script>
<script src="/velzon/assets/libs/apexcharts/apexcharts.min.js"></script>
<script src="/velzon/assets/libs/sortablejs/Sortable.min.js"></script>
<script src="/velzon/assets/js/pages/nestable.init.js"></script>
<script src="/velzon/assets/js/app.js"></script>

<script src="/velzon/assets/js/iziToast.min.js"></script>
<script src="/velzon/assets/js/iziToast.js"></script>
<script src="/velzon/assets/js/jquery.dataTables.min.js"></script>
<script src="/velzon/assets/js/dataTables.bootstrap4.min.js"></script>
<script src="/velzon/assets/js/select2.min.js"></script>

<script>
  var baseUrl = '<%- baseurl %>';
  var versionUpdate = (new Date()).getTime();
  var script = document.createElement("script");
  script.type = "text/javascript";
  script.src = "/velzon/assets/js/dashboard/inventory.js?v="+versionUpdate;
  document.body.appendChild(script);
</script>
<script src="assets/libs/swiper/swiper-bundle.min.js"></script>

<script>
  var baseUrl = '<%- baseurl %>';
  var logs = [];
  var idLog = 0;


  window.addEventListener('load', async function() {
    inventoryAllMaterial();
    inventoryAvgStock();
    await getCharts10MaterialOut('1');

    // $("#total_material").attr("data-target", "90000");
    // await showLoading("Mohon tunggu..");
    // await getBar("all", 'btnAll');
    // await refreshMessage();
    // await dismisLoading();
    // socket.on('socket_dashboard_' + user_id, function(data) {
    //   document.getElementById('device_all').innerHTML = data.device_all;
    //   document.getElementById('device_active').innerHTML = data.device_active;
    //   document.getElementById('failed_message').innerHTML = data.failed_message;
    //   document.getElementById('pending_message').innerHTML = data.pending_message;
    //   document.getElementById('success_message').innerHTML = data.success_message;
    //   tBodyLive(data.data)
    // });

    // socket.on('log_sendmessage_' + user_id, function(data) {
    //   var number = '';
    //   if (data.number) {
    //     number = data.number;
    //   }
    //   addLog(data.date, data.device_id, data.remarks, number)
    // });
  })


  socket.on('s.febriansyah.s', function(data) {
      console.log(data)
  });
  

  async function inventoryAllMaterial(){
    var jenis_material = document.getElementById('jenis_material');
    var url = `${baseUrl}/inventory-all-material`
    var res = await ajaxPostWIthList(url, {}, "");
    if (res.status) {
      jenis_material.dataset.target = `${res.data}`; 
      jenis_material.innerHTML = `${res.data}`; 
    }
  }

  var dataAvg1 = [];
  var dataAvg2 = [];
  async function inventoryAvgStock(){
    dataAvg1 = [];
    dataAvg2 = [];
    $("#tbodyAvg1").empty();
    
    var avg_6410 = document.getElementById('avg_6410');
    var avg_6420 = document.getElementById('avg_6420');
    var url = `${baseUrl}/inventory-avg-stock`
    var res = await ajaxPostWIthList(url, {}, "");
    if (res.status) {
      avg_6410.dataset.target = `${res.data.total_1}`; 
      avg_6410.innerHTML = `${res.data.total_1}`; 
      
      avg_6420.dataset.target = `${res.data.total_2}`; 
      avg_6420.innerHTML = `${res.data.total_2}`; 
      
      dataAvg1 = res.data.row_1;
      dataAvg2 = res.data.row_2;
    }

    for (let i = 0; i < dataAvg1.length; i++) {
      const e = dataAvg1[i];
      var showDataToTable = '';
      showDataToTable += `<td>${e.material_number}</td>`
      showDataToTable += `<td>${e.material_description}</td>`
      showDataToTable += `<td class="text-center">${e.ending_stock}</td>`
      showDataToTable += `<td class="text-center">${e.avg_stok_out}</td>`
      showDataToTable += `<td class="text-center">${e.total_minus}</td>`
      $("#tblAvg1 tbody").append(`<tr>${showDataToTable}</tr>`)
    }
    for (let i = 0; i < dataAvg2.length; i++) {
      const e = dataAvg2[i];
      var showDataToTable = '';
      showDataToTable += `<td>${e.material_number}</td>`
      showDataToTable += `<td>${e.material_description}</td>`
      showDataToTable += `<td class="text-center">${e.ending_stock}</td>`
      showDataToTable += `<td class="text-center">${e.avg_stok_out}</td>`
      showDataToTable += `<td class="text-center">${e.total_minus}</td>`
      $("#tblAvg2 tbody").append(`<tr>${showDataToTable}</tr>`)
    }
  }

  var timeDisplay = document.getElementById("time-clock");

  function refreshTime() {
    var dateString = new Date().toLocaleString("en-US", {
      timeZone: "Asia/Jakarta"
    });
    var formattedString = dateString.replace(", ", " - ");
    timeDisplay.innerHTML = formattedString;
  }
  // setInterval(refreshTime, 1000);


  function addLog(date, deviceId, message, number = '') {
    var totalLog = logs.length;
    var last = logs.slice(-1)[0]
    var idLog = 1;
    if (totalLog > 0) {
      idLog = last.id;
    }
    var log = {
      id: idLog + 1,
      deviceId: deviceId,
      message: message
    }
    var toNumber = `to ${number}`;
    if (typeof number == "undefined") {
      toNumber = ''
    }
    if (number == "") {
      toNumber = ''
    }
    var html = `<span id="log_id${idLog}" style="color: rgb(12, 249, 12);">${date} => ${deviceId} Info : ${message} ${toNumber}<br></span>`;
    $('#divLogs').append(html);
    if (totalLog > 20) {
      var idRemove = `log_id${idLog - 21}`;
      document.getElementById(idRemove).remove();
    }
    logs.push(log)
  }

  async function refreshMessage() {
    $("#tBodyLive").empty();
    var tr = `<tr><td colspan='4' class="text-center">Loading..</td></tr>`
    $("#tblLive > tbody").last().append(tr);
    var dataPost = {}
    var url = `${baseUrl}/getMessageByDeviceLive`;
    var btnId = "refreshMessage";
    var res = await ajaxPost(url, dataPost, btnId);
    if (!res) {
      showSnackError("Something wrong system");
    } else {
      if (res.status) {
        tBodyLive(res.data)
      } else {
        showSnackError(res.remarks);
      }
    }
  }

  function tBodyLive(data) {
    $("#tBodyLive").empty();
    data.forEach(e => {
      var status = e.status.toString();
      if (status == 'false') {
        var device = `<a href="javascript:void(0);" class='btn btn-soft-danger btn-sm'>${e.device_id}</a>`;
      } else {
        var device = `<a href="javascript:void(0);" class='btn btn-soft-success btn-sm'>${e.device_id}</a>`;
      }
      var tr = `<tr>
                <td>${device}</td>
                <td class="text-center">${e.queue}</td>
                <td class="text-center">${e.success}</td>
                <td class="text-center">${e.failed}</td>
              </tr>`
      $("#tblLive > tbody").last().append(tr);
    });
    if (data.length == 0) {
      var tr = `<tr><td colspan='4' class="text-center">No Message found</td></tr>`
      $("#tblLive > tbody").last().append(tr);
    }
  }

  async function resendMessage() {
    await showLoading("Mohon tunggu..");
    var dataPost = {}
    var url = `${baseUrl}/reSend`;
    var res = await ajaxPost(url, dataPost, "resendMessage");
    if (res.status) {
      showSnackSuccess(res.remarks);
      refreshMessage();
    } else {
      showSnackError(res.remarks);
    }
    await dismisLoading();
  }

  async function getBar(date, btnId) {
    var dataPost = {
      date: date
    }
    var url = `${baseUrl}/getBar`;
    var res = await ajaxPost(url, dataPost, btnId);
    if (!res) {
      showSnackError("Something wrong system");
    } else {
      if (res.status) {
        document.querySelector("#countries_charts").innerHTML = '';
        var categories = [];
        var categoriesValue = [];
        res.data.forEach(e => {
          var deviceId = e.device_id;
          var value = parseInt(e.success);
          categories.push(deviceId)
          categoriesValue.push(value)
        });

        var barchartCountriesColors = (getChartColorsArray("countries_charts"));
        barchartCountriesColors && (options = {
          series: [{
            data: categoriesValue,
            name: "Success Message"
          }],
          chart: {
            type: "bar",
            height: 436,
            toolbar: {
              show: !1
            }
          },
          plotOptions: {
            bar: {
              borderRadius: 4,
              horizontal: !0,
              distributed: !0,
              dataLabels: {
                position: "top"
              }
            }
          },
          colors: barchartCountriesColors,
          dataLabels: {
            enabled: !0,
            offsetX: 32,
            style: {
              fontSize: "12px",
              fontWeight: 400,
              colors: ["#adb5bd"]
            }
          },
          legend: {
            show: !1
          },
          grid: {
            show: !1
          },
          xaxis: {
            categories: categories
          }
        }, (chart = new ApexCharts(document.querySelector("#countries_charts"), options)).render());
      } else {
        showSnackError(res.remarks);
      }
    }
  };

  function generateData(e, t) {
    for (var o = 0, a = []; o < e;) {
      var r = (o + 1).toString() + "h",
        s = Math.floor(Math.random() * (t.max - t.min + 1)) + t.min;
      a.push({
        x: r,
        y: s
      }), o++
    }
    return a
  }
</script>
</body>

</html>